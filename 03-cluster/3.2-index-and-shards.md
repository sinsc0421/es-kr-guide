---
description: >-
  이 문서의 허가되지 않은 무단 복제나 배포 및 출판을 금지합니다. 본 문서의 내용 및 도표 등을 인용하고자 하는 경우 출처를 명시하고
  김종민(kimjmin@gmail.com)에게 사용 내용을 알려주시기 바랍니다.
coverY: 0
---

# 3.2 인덱스와 샤드(Index\&Shards)

Elasticsearch 에서는 <mark style="background-color:yellow;">단일 데이터 단위를</mark> <mark style="background-color:yellow;"></mark><mark style="background-color:yellow;">**도큐먼트(document)**</mark> 라고 하며 <mark style="background-color:yellow;">이 도큐먼트를 모아 놓은 집합을</mark> <mark style="background-color:yellow;"></mark><mark style="background-color:yellow;">**인덱스(Index)**</mark> <mark style="background-color:yellow;"></mark><mark style="background-color:yellow;"></mark> 라고 합니다.&#x20;

인덱스라는 단어가 여러 뜻으로 사용되기 때문에 데이터 저장 단위인 인덱스는 **인디시즈(indices)** 라고 표현하기도 합니다.&#x20;

&#x20;이 책에서는 <mark style="background-color:yellow;">데이터를 Elasticsearch에 저장하는 행위는</mark> <mark style="background-color:yellow;"></mark><mark style="background-color:yellow;">**색인**</mark>, 그리고 <mark style="background-color:yellow;">도큐먼트의 집합 단위는</mark> <mark style="background-color:yellow;"></mark><mark style="background-color:yellow;">**인덱스**</mark> 라고 하겠습니다. **인덱스**는 기본적으로 \*\***샤드(shard)**\*\*라는 단위로 분리되고, **각 노드에 분산되어 저장**이 됩니다. 샤드는 루씬의 단일 검색 인스턴스 입니다.&#x20;

다음은 하나의 인덱스가 5개의 샤드로 저장되도록 설정한 예 입니다.

![](<../.gitbook/assets/image (19) (1).png>)

### 프라이머리 샤드(Primary Shard)와 복제본(Replica)

인덱스를 생성할 때 별도의 설정을 하지 않으면 <mark style="background-color:yellow;">**7.0 버전부터는 디폴트로 1개의 샤드로 인덱스가 구성**</mark>되며 **6.x** 이하 버전에서는 **5개**로 구성됩니다.&#x20;

클러스터에 노드를 추가하게 되면 샤드들이 각 노드들로 분산되고 디폴트로 1개의 복제본을 생성합니다.

&#x20;<mark style="background-color:yellow;">처음 생성된 샤드를</mark> <mark style="background-color:yellow;"></mark><mark style="background-color:yellow;">**프라이머리 샤드(Primary Shard)**</mark><mark style="background-color:yellow;">, 복제본은</mark> <mark style="background-color:yellow;"></mark><mark style="background-color:yellow;">**리플리카(Replica)**</mark> <mark style="background-color:yellow;"></mark><mark style="background-color:yellow;"></mark> 라고 부릅니다.&#x20;

예를 들어 한 인덱스가 5개의 샤드로 구성되어 있고, 클러스터가 4개의 노드로 구성되어 있다고 가정하면 각각 5개의 프라이머리 샤드와 복제본, 총 10개의 샤드들이 전체 노드에 골고루 분배되어 저장됩니다.



![5개의 프라이머리 샤드와 복제본이 4개의 노드에 분산되어 저장된 예](<../.gitbook/assets/image (20) (1).png>)

{% hint style="danger" %}
노드가 1개만 있는 경우 **프라이머리 샤드만 존재**하고 복제본은 생성되지 않습니다. Elasticsearch 는 아무리 작은 클러스터라도 <mark style="background-color:yellow;">**데이터 가용성과 무결성을 위해 최소 3개**</mark>의 노드로 구성 할 것을 권장하고 있습니다. (홀수로 구성 권장)
{% endhint %}

같은 샤드와 복제본은 동일한 데이터를 담고 있으며 **반드시 서로 다른 노드에 저장이 됩니다**.&#x20;

&#x20;만약에 위 그림에서 Node-3 노드가 시스템 다운이나 네트워크 단절등으로 사라지면 이 클러스터는 Node-3 에 있던 0번과 4번 샤드들을 유실하게 됩니다.&#x20;

&#x20;하지만 아직 다른 노드들 Node-1, Node-2 에 0번, 4번 샤드가 남아있으므로 여전히 전체 데이터는 유실이 없이 사용이 가능합니다.



![Node-3 노드가 유실되어 0번, 4번 샤드가 다른 노드에 복제본을 새로 생성한 예](<../.gitbook/assets/image (21) (1).png>)

1\) 처음에 클러스터는 먼저 유실된 노드가 복구 되기를 기다립니다.&#x20;

2\) 하지만 타임아웃이 지나 더 유실된 노드가 복구되지 않는다고 판단이 되면 Elasticsearch는 복제본이 사라져 1개만 남은 0번, 4번 샤드들의 복제를 시작합니다.&#x20;

3\) 처음에 4개였던 노드가 3개로 줄어도 복제가 끝나면 0\~4번 까지의 프라이머리 샤드, 복제본이 각각 5개씩 총 10개의 데이터로 유지됩니다.



![노드가 3개로 줄었을 때도 전체 데이터 유지](<../.gitbook/assets/image (22).png>)

이렇게 프라이머리 샤드와 리플리카를 통해 Elasticsearch는 운영 중에 노드가 유실 되어도 데이터를 잃어버리지 않고 데이터의 가용성과 무결성을 보장합니다.

{% hint style="warning" %}
**프라이머리 샤드가 유실된 경우에는 새로 프라이머리 샤드가 생성되는 것이 아니라, **<mark style="background-color:yellow;">**남아있던 복제본이 먼저 프라이머리 샤드로 승격**</mark>이 되고 다른 노드에 새로 복제본을 생성하게 됩니다.
{% endhint %}

### 샤드 개수 설정

샤드의 개수는 인덱스를 처음 생성할 때 지정할 수 있습니다.&#x20;

&#x20;프라이머리 샤드 수는 인덱스를 처음 생성할 때 지정하며, **인덱스를 재색인 하지 않는 이상 바꿀 수 없습니다**. 복제본의 개수는 나중에 변경이 가능합니다.&#x20;

&#x20;아래는 curl 명령을 통해 REST API로 샤드가 5개, 복제본은 1개인 books 라는 이름의 인덱스를 생성하는 예제입니다.&#x20;

REST API에 대해서는 다음 장에서 더 자세히 다루도록 하겠습니다.

{% code title="프라이머리 샤드 5, 복제본 1 인 books 인덱스 생성" %}
```bash
$ curl -XPUT "http://localhost:9200/books" -H 'Content-Type: application/json' -d'
{
  "settings": {
    "number_of_shards": 5,
    "number_of_replicas": 1
  }
}'
```
{% endcode %}

books 인덱스의 복제본 수를 0으로 변경하려면 아래 명령으로 업데이트가 가능합니다.

{% code title="books 인덱스의 복제본 개수를 0 으로 변경" %}
```bash
$ curl -XPUT "http://localhost:9200/books/_settings" -H 'Content-Type: application/json' -d'
{
  "number_of_replicas": 0
}'
```
{% endcode %}

&#x20;만약에 4개의 노드를 가진 클러스터에 프라이머리 샤드 5개, 복제본 1개인 books 인덱스, 그리고 프라이머리 샤드 3개 복제본 0개인 magazines 인덱스가 있다고 하면 전체 샤드들은 아래와 같은 모양으로 배치될 수 있습니다.

![books 인덱스와 magazines 인덱스](<../.gitbook/assets/image (23).png>)
